<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>会员管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../lib/layui-v2.5.4/css/layui.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
</head>

<body>
    <div class="layuimini-container">
        <div class="layuimini-main">
            <fieldset class="layui-elem-field layuimini-search">
                <legend>会员信息搜索</legend>
                <div style="margin: 10px 10px 10px 10px">
                    <form class="layui-form layui-form-pane" action="">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">会员姓名</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="realName" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">会员卡号</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="cardID" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">手机号</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="phone" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <a class="layui-btn" lay-submit="" lay-filter="data-search-btn">搜索</a>
                            </div>
                    </form>
                    </div>
            </fieldset>
            <div class="layui-btn-group">
                <button class="layui-btn layui-btn-danger data-delete-btn">删除</button>
            </div>
            <table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>
            <script type="text/html" id="currentTableBar">
                <a class="layui-btn layui-btn-xs data-count-edit" lay-event="edit">查看详情</a>
                <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="ban">封禁/解封</a>
                <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="forbidden">黑名单</a>
            </script>
            </div>
        </div>
        <script src="../lib/layui-v2.5.4/layui.js" charset="utf-8"></script>
        <script type="text/html" id="banState">
            {{#if (d.isBan == 0) { }}
            <span>未封禁</span> {{# }else if(d.isBan == 1){ }}
            <span>已封禁</span> {{# } }}
        </script>
        <script>
        layui.use(['form', 'table'], function() {
            var $ = layui.jquery,
                form = layui.form,
                table = layui.table;

            table.render({
                elem: '#currentTableId',
                url: '/admin/?p=index&searchMember=1',
                cols: [
                    [
                        { type: "checkbox", width: 50, fixed: "left" },
                        { field: 'cardID', width: 120, title: '卡号' },
                        { field: 'realName', width: 100, title: '姓名' },
                        { field: 'sex', width: 60, title: '性别' },
                        { field: 'phone', width: 120, title: '手机号' },
                        { field: 'activeTime', width: 180, title: '激活时间' },
                        { field: 'usedTimes', width: 90, title: '使用次数' },
                        { field: 'isBan', width: 100, title: '封禁状态', templet: '#banState' },
                        { field: 'state', width: 80, title: '黑名单', templet: function (d) {return d.state==2?"黑名单":"";} },
                        { title: '操作', minWidth: 50, templet: '#currentTableBar', fixed: "right", align: "center" }
                    ]
                ],
                limits: [10, 15, 20, 25, 50, 100],
                limit: 15,
                page: true
            });

            // 监听搜索操作
            form.on('submit(data-search-btn)', function(data) {
                var result = JSON.stringify(data.field);
                // layer.alert(result, {
                //     title: '最终的搜索信息'
                // });

                //执行搜索重载
                table.reload('currentTableId', {
                    page: {
                        curr: 1
                    },
                    where: {
                        searchParams: result
                    }
                }, 'data');

                return false;
            });

            // 监听添加操作
            $(".data-add-btn").on("click", function() {
                window.location.href = "hy-form.html"

            });

            // 监听删除操作
            $(".data-delete-btn").on("click", function() {
                var checkStatus = table.checkStatus('currentTableId'),
                    data = checkStatus.data;
                layer.alert(JSON.stringify(data));
            });

            //监听表格复选框选择
            table.on('checkbox(currentTableFilter)', function(obj) {
                console.log(obj)
            });

            table.on('tool(currentTableFilter)', function(obj) {
                var data = obj.data;
                if (obj.event === 'edit') {
                    window.location.href = "hy-form.html#/id=" + data.userid;
                } else if (obj.event === 'ban') {
                    if (data.isBan == 0) {
                        layer.confirm('真的要封禁用户吗？', function(index) {
                            $.get("/admin/?p=index&banUser=1&type=1&id=" + data.userid, function(result) {
                                if (result == 1) {
                                    obj.update({
                                        isBan: 1
                                    });
                                }
                            });
                            layer.close(index);
                        });
                    } else {
                        layer.confirm('真的要解封用户吗？', function(index) {
                            $.get("/admin/?p=index&banUser=1&type=0&id=" + data.userid, function(result) {
                                if (result == 1) {
                                    obj.update({
                                        isBan: 0
                                    });
                                }
                            });
                            layer.close(index);
                        });
                    }
                } else if (obj.event === 'forbidden') {
                    if (data.state != 2) {
                        layer.confirm('真的要将用户加入黑名单吗？', function(index) {
                            $.get("/admin/?p=index&forbidden=1&type=1&id=" + data.userid, function(result) {
                                if (result == 1) {
                                    obj.update({
                                        state: 2
                                    });
                                }
                            });
                            layer.close(index);
                        });
                    } else {
                        layer.confirm('真的要将用户移出黑名单吗？', function(index) {
                            $.get("/admin/?p=index&forbidden=1&type=0&id=" + data.userid, function(result) {
                                if (result == 1) {
                                    obj.update({
                                        state: 0
                                    });
                                }
                            });
                            layer.close(index);
                        });
                    }
                }
            });

        });
        </script>
        <script>
        </script>
</body>

</html>